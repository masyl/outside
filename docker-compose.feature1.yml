version: '3.8'

services:
  game-server:
    build:
      context: .
      dockerfile: packages/server/Dockerfile
    container_name: game-server-feature1
    restart: unless-stopped
    networks:
      - traefik-proxy
    environment:
      - NODE_ENV=development
      - PORT=3000
      - WS_PORT=3001
    labels:
      - 'traefik.enable=true'
      - 'traefik.http.routers.game-server-feature1.rule=Host(`api.feature1.outside.local`)'
      - 'traefik.http.routers.game-server-feature1.entrypoints=https'
      - 'traefik.http.routers.game-server-feature1.tls=true'
      - 'traefik.http.routers.game-server-feature1.tls.certresolver=local'
      - 'traefik.http.services.game-server-feature1.loadbalancer.server.port=3000'
      - 'traefik.http.routers.game-server-ws-feature1.rule=Host(`ws.feature1.outside.local`)'
      - 'traefik.http.routers.game-server-ws-feature1.entrypoints=https'
      - 'traefik.http.routers.game-server-ws-feature1.tls=true'
      - 'traefik.http.routers.game-server-ws-feature1.tls.certresolver=local'
      - 'traefik.http.services.game-server-ws-feature1.loadbalancer.server.port=3001'

  game-client:
    build:
      context: .
      dockerfile: packages/client/Dockerfile
    container_name: game-client-feature1
    restart: unless-stopped
    networks:
      - traefik-proxy
    environment:
      - NODE_ENV=development
      - VITE_API_URL=https://api.feature1.outside.local
      - VITE_WS_URL=wss://api.feature1.outside.local
    labels:
      - 'traefik.enable=true'
      - 'traefik.http.routers.game-client-feature1.rule=Host(`feature1.outside.local`)'
      - 'traefik.http.routers.game-client-feature1.entrypoints=https'
      - 'traefik.http.routers.game-client-feature1.tls=true'
      - 'traefik.http.routers.game-client-feature1.tls.certresolver=local'
      - 'traefik.http.services.game-client-feature1.loadbalancer.server.port=5174'

  storybook:
    build:
      context: .
      dockerfile: packages/storybook/Dockerfile
    container_name: storybook-feature1
    restart: unless-stopped
    networks:
      - traefik-proxy
    environment:
      - NODE_ENV=development
    labels:
      - 'traefik.enable=true'
      - 'traefik.http.routers.storybook-feature1.rule=Host(`storybook.feature1.outside.local`)'
      - 'traefik.http.routers.storybook-feature1.entrypoints=https'
      - 'traefik.http.routers.storybook-feature1.tls=true'
      - 'traefik.http.routers.storybook-feature1.tls.certresolver=local'
      - 'traefik.http.services.storybook-feature1.loadbalancer.server.port=6007'

networks:
  traefik-proxy:
    external: true
