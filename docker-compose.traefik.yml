services:
  traefik:
    image: traefik:v3.1
    container_name: traefik
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    networks:
      - traefik-proxy
    ports:
      - '80:80'
      - '443:443'
      - '8080:8080' # Traefik dashboard
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik/traefik.yml:/traefik.yml:ro
      - ./traefik/acme.json:/acme.json
      - ./traefik/dynamic:/dynamic:ro
      - ./_wildcard.outside.local+2.pem:/certs/_wildcard.outside.local+2.pem:ro
      - ./_wildcard.outside.local+2-key.pem:/certs/_wildcard.outside.local+2-key.pem:ro
    environment:
      - TRAEFIK_CERTIFICATESRESOLVERS_LOCAL_ACME_CASERVER=https://acme-v02.api.letsencrypt.org/directory
      - TRAEFIK_CERTIFICATESRESOLVERS_LOCAL_ACME_EMAIL=admin@outside.local
      - TRAEFIK_CERTIFICATESRESOLVERS_LOCAL_ACME_STORAGE=acme.json
    labels:
      - 'traefik.enable=true'
      - 'traefik.http.routers.traefik.entrypoints=http'
      - 'traefik.http.routers.traefik.rule=Host(`traefik.outside.local`)'
      - 'traefik.http.middlewares.traefik-auth.basicauth.users=admin:$$apr1$$h6x3o6h9$$jR2dQJQk7QgV8E9fTn.9.'
      - 'traefik.http.middlewares.traefik-https.redirectscheme.scheme=https'
      - 'traefik.http.routers.traefik.middlewares=traefik-https'
      - 'traefik.http.routers.traefik-secure.entrypoints=https'
      - 'traefik.http.routers.traefik-secure.rule=Host(`traefik.outside.local`)'
      - 'traefik.http.routers.traefik-secure.middlewares=traefik-auth'
      - 'traefik.http.routers.traefik-secure.tls=true'
      - 'traefik.http.routers.traefik-secure.tls.certresolver=local'
      - 'traefik.http.routers.traefik-secure.service=api@internal'

networks:
  traefik-proxy:
    external: true
